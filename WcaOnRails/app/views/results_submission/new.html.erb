<% provide(:title, "Results submission") %>
<% provide(:include_markdown_editor, true) %>
<%= render layout: 'nav' do %>
  <h1><%= yield(:title) %></h1>

  <% if @competition.results_submitted? %>
    <p>The results have already been submitted. If you have any more questions or comments please reply to the email sent with the first results submission.</p>
  <% else %>
    <p>
      The result submission process has two steps:
      <ul>
        <li>Uploading a valid JSON to the website</li>
        <li>Then the website will run a number of checks. If everything is correct you'll be able to submit these results to the WRT.</li>
      </ul>
    </p>
    <% panel_style = @inbox_results.any? ? "success" : "warning" %>
    <div class="panel panel-<%= panel_style %>">
      <div class="panel-heading heading-as-link <%= "collapsed" if @inbox_results.any? %>" data-toggle="collapse" data-target="#collapse-submit-json">
        <h3 class="panel-title">
          Upload a JSON file
          <span class="collapse-indicator"></span>
        </h3>
      </div>
      <div id="collapse-submit-json" class="panel-body collapse <%= "in" unless @inbox_results.any? %>">
        <% if @inbox_results.any? %>
          <div class="alert alert-info">Some results are already there, uploading a new (valid) JSON will override all of them!</div>
        <% else %>
          <p>Please start by selecting a JSON file to import.</p>
        <% end %>
        <%= simple_form_for @upload_json, url: upload_results_json_path do |f| %>
          <%= f.input :results_file, as: :file, input_html: { accept: 'application/json' }, label: "Results JSON file" %>
          <%= f.submit "Submit", class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>

    <%
      panel_style = if @inbox_results.empty? || @total_errors > 0
                      "danger"
                    elsif @total_warnings > 0
                      "warning"
                    else
                      "success"
                    end
    %>

    <div class="panel panel-<%= panel_style %>">
      <div class="panel-heading heading-as-link <%= "collapsed" unless @inbox_results.any? %>" data-toggle="collapse" data-target="#collapse-check-results">
        <h3 class="panel-title">
          Check imported results
          <span class="collapse-indicator"></span>
        </h3>
      </div>
      <div id="collapse-check-results" class="panel-body collapse <%= "in" if @inbox_results.any? %>">
        <h3>Errors</h3>
        <% if @total_errors > 0 %>
          <p>Please fix the errors below:</p>
          <% @all_errors.each do |type, errors| %>
            <% if errors.any? %>
              <h4>Errors detected in <%= type %></h4>
              <ul>
                <% errors.each do |error| %>
                  <li><%= error %></li>
                <% end %>
              </ul>
            <% end %>
          <% end %>
        <% elsif @inbox_results.empty? %>
          <p class="text-danger">No results submitted yet.</p>
        <% else %>
          <p>No error detected in the submitted results.</p>
        <% end %>
        <h3>Warnings</h3>
        <% if @total_warnings > 0 %>
          <p>Please pay attention to the warnings below. You may need to add a comment about them when submitting these results to the WRT!</p>
          <% @all_warnings.each do |type, warnings| %>
            <% if warnings.any? %>
              <h4>Warnings detected in <%= type %></h4>
              <ul>
                <% warnings.each do |warning| %>
                  <li><%= warning %></li>
                <% end %>
              </ul>
            <% end %>
          <% end %>
        <% elsif @inbox_results.empty? %>
          <p class="text-danger">No results submitted yet.</p>
        <% else %>
          <p>No warning detected in the submitted results.</p>
        <% end %>
      </div>
    </div>
    <div class="panel panel-default">
      <div class="panel-heading heading-as-link <%= "collapsed" unless (@inbox_results.any? && @total_errors == 0) %>" data-toggle="collapse" data-target="#collapse-submit-results">
        <h3 class="panel-title">
          Submit the results to the Results Team.
          <span class="collapse-indicator"></span>
        </h3>
      </div>
      <div id="collapse-submit-results" class="panel-body collapse <%= "in" if @inbox_results.any? && @total_errors == 0 %>">
        <% if @total_errors == 0 && @inbox_results.any? %>
          <p>Please enter the body of your email to the Results Team.</p>
          <p>
          Make sure to include a link to the competition schedule (and all time
          limits and cutoffs) and provide any changes to the provided schedule, as
          well as any other additional details required by the
          <%= link_to "'Submitting competition results' section of the delegate crash course",
            delegate_crash_course_path(anchor: "submitting-competition-results") %>.
          </p>

          <%= simple_form_for @results_submission, url: submit_results_path do |f| %>
            <%= f.input :schedule_url %>
            <%= f.input :message, as: :text, input_html: { class: "markdown-editor" } %>
            <%= f.submit "Submit", class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <p>Please upload a JSON file and make sure the results don't contain any error.</p>
        <% end %>
      </div>
    </div>
  <% end %>

<% end %>
